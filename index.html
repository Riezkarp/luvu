import { useState, useEffect } from 'react';
import { Beaker, Brain, Thermometer, Droplets, Award, Book, BarChart2, Clock, ChevronRight, Info, Play, Star } from 'lucide-react';

export default function KoligatifQuest() {
  const [gameState, setGameState] = useState({
    screen: 'welcome', // welcome, levels, game, lab, quiz
    currentLevel: 0,
    score: 0,
    molecularEnergy: 50,
    achievements: [],
    hints: 3,
    currentQuiz: null,
    quizAnswered: false,
    correctAnswer: null,
    selectedAnswer: null,
    labData: {},
    timer: 0,
  });

  const levels = [
    {
      id: 1,
      title: "Penurunan Tekanan Uap",
      concept: "ΔP = X_solut × P_pelarut",
      icon: <Beaker size={28} />,
      color: "bg-blue-500",
      unlocked: true,
      completed: false,
      description: "Pelajari konsep fraksi mol dan pengaruhnya pada tekanan uap larutan."
    },
    {
      id: 2,
      title: "Kenaikan Titik Didih",
      concept: "ΔTb = i·Kb·m",
      icon: <Thermometer size={28} />,
      color: "bg-red-500",
      unlocked: false,
      completed: false,
      description: "Eksperimen dengan pemanasan larutan dan amati perubahan titik didih."
    },
    {
      id: 3,
      title: "Penurunan Titik Beku",
      concept: "ΔTf = i·Kf·m",
      icon: <Droplets size={28} />,
      color: "bg-indigo-500",
      unlocked: false,
      completed: false,
      description: "Buat cairan anti-beku dan pelajari aplikasi krioskopi."
    },
    {
      id: 4,
      title: "Tekanan Osmotik",
      concept: "π = i·M·R·T",
      icon: <Brain size={28} />,
      color: "bg-green-500",
      unlocked: false,
      completed: false,
      description: "Visualisasikan osmosis pada level molekuler dan aplikasinya dalam biokimia."
    },
    {
      id: 5,
      title: "Lab Rahasia",
      concept: "Integrates All Concepts",
      icon: <Award size={28} />,
      color: "bg-purple-500",
      unlocked: false,
      completed: false,
      description: "Tantangan kompleks yang mengintegrasikan semua konsep sifat koligatif."
    }
  ];

  const toolsAndPowerups = [
    { 
      id: "labNotes", 
      name: "Lab Notes", 
      description: "Petunjuk untuk level saat ini", 
      cost: 10,
      icon: <Book size={20} />
    },
    { 
      id: "molecularScanner", 
      name: "Molecular Scanner", 
      description: "Menganalisis komposisi larutan", 
      cost: 15,
      icon: <BarChart2 size={20} />
    },
    { 
      id: "timeFreeze", 
      name: "Time Freeze", 
      description: "Menghentikan timer selama 10 detik", 
      cost: 20,
      icon: <Clock size={20} />
    },
    { 
      id: "formulaSheet", 
      name: "Formula Sheet", 
      description: "Akses cepat ke rumus-rumus penting", 
      cost: 15,
      icon: <Info size={20} />
    }
  ];

  const quizzes = {
    1: [
      {
        question: "Apa yang terjadi pada tekanan uap pelarut murni ketika zat terlarut ditambahkan?",
        options: [
          "Tekanan uap meningkat",
          "Tekanan uap menurun",
          "Tekanan uap tidak berubah",
          "Tekanan uap menjadi nol"
        ],
        correctAnswer: 1,
        explanation: "Saat zat terlarut yang tidak mudah menguap ditambahkan ke pelarut, molekul pelarut di permukaan berkurang, menurunkan laju penguapan dan tekanan uap."
      },
      {
        question: "Jika fraksi mol zat terlarut dalam larutan adalah 0,2, berapa fraksi penurunan tekanan uap relatif?",
        options: [
          "0,1",
          "0,2",
          "0,8",
          "2,0"
        ],
        correctAnswer: 1,
        explanation: "Menurut Hukum Raoult, penurunan tekanan uap relatif sama dengan fraksi mol zat terlarut. Jadi ΔP/P° = X_solut = 0,2"
      }
    ],
    2: [
      {
        question: "Faktor apa yang tidak mempengaruhi kenaikan titik didih?",
        options: [
          "Konsentrasi molal zat terlarut",
          "Konstanta molal titik didih (Kb)",
          "Tekanan atmosfer",
          "Faktor van't Hoff (i)"
        ],
        correctAnswer: 2,
        explanation: "Kenaikan titik didih dipengaruhi oleh konsentrasi molal zat terlarut, konstanta Kb, dan faktor van't Hoff, bukan tekanan atmosfer (meskipun tekanan atmosfer mempengaruhi titik didih sendiri)."
      }
    ]
  };

  // Lab simulation data
  const labSimulations = {
    1: {
      title: "Simulasi Penurunan Tekanan Uap",
      description: "Amati perubahan tekanan uap dengan menambahkan zat terlarut ke dalam air.",
      initialState: {
        solventMass: 100, // gram air
        solventMolarMass: 18, // g/mol untuk air
        soluteMolarMass: 60, // g/mol untuk zat terlarut (contoh: urea)
        purevaporPressure: 23.8, // mmHg pada 25°C
        soluteMass: 0, // akan diubah pengguna
      },
      calculateResult: (data) => {
        const solventMoles = data.solventMass / data.solventMolarMass;
        const soluteMoles = data.soluteMass / data.soluteMolarMass;
        const totalMoles = solventMoles + soluteMoles;
        const soluteMoleFraction = soluteMoles / totalMoles;
        const solventMoleFraction = 1 - soluteMoleFraction;
        
        // Hukum Raoult
        const vaporPressure = data.purevaporPressure * solventMoleFraction;
        const pressureReduction = data.purevaporPressure - vaporPressure;
        
        return {
          vaporPressure: vaporPressure.toFixed(2),
          pressureReduction: pressureReduction.toFixed(2),
          soluteMoleFraction: soluteMoleFraction.toFixed(4),
          solventMoleFraction: solventMoleFraction.toFixed(4)
        };
      }
    }
  };
  
  const useToolOrPowerup = (toolId) => {
    const tool = toolsAndPowerups.find(t => t.id === toolId);
    if (gameState.molecularEnergy >= tool.cost) {
      setGameState({
        ...gameState,
        molecularEnergy: gameState.molecularEnergy - tool.cost
      });
      
      // Implementasi efek tool
      switch(toolId) {
        case "labNotes":
          // Tampilkan hint
          break;
        case "timeFreeze":
          // Freeze timer
          break;
        // Implementasi tool lainnya
      }
    }
  };

  const startLevel = (levelId) => {
    setGameState({
      ...gameState,
      screen: 'game',
      currentLevel: levelId
    });
  };

  const startQuiz = () => {
    if (quizzes[gameState.currentLevel]) {
      const randomIndex = Math.floor(Math.random() * quizzes[gameState.currentLevel].length);
      setGameState({
        ...gameState,
        screen: 'quiz',
        currentQuiz: quizzes[gameState.currentLevel][randomIndex],
        quizAnswered: false,
        selectedAnswer: null,
        timer: 30 // Timer 30 detik
      });
    }
  };

  const answerQuiz = (answerIndex) => {
    const correct = answerIndex === gameState.currentQuiz.correctAnswer;
    const pointsGained = correct ? 10 : -5;
    const energyGained = correct ? 5 : 0;
    
    setGameState({
      ...gameState,
      quizAnswered: true,
      selectedAnswer: answerIndex,
      score: gameState.score + pointsGained,
      molecularEnergy: gameState.molecularEnergy + energyGained
    });
  };

  const startLabSimulation = () => {
    if (labSimulations[gameState.currentLevel]) {
      setGameState({
        ...gameState,
        screen: 'lab',
        labData: { ...labSimulations[gameState.currentLevel].initialState }
      });
    }
  };

  const updateLabParameter = (param, value) => {
    setGameState({
      ...gameState,
      labData: {
        ...gameState.labData,
        [param]: value
      }
    });
  };

  const calculateLabResults = () => {
    const results = labSimulations[gameState.currentLevel].calculateResult(gameState.labData);
    setGameState({
      ...gameState,
      labData: {
        ...gameState.labData,
        results
      },
      score: gameState.score + 15, // Points for completing simulation
      molecularEnergy: gameState.molecularEnergy + 10
    });
  };

  const goToLevels = () => {
    setGameState({
      ...gameState,
      screen: 'levels'
    });
  };

  // UI Components
  const WelcomeScreen = () => (
    <div className="flex flex-col items-center justify-center space-y-6 p-6 text-center bg-pink-600 min-h-screen">
      <div className="bg-pink-700/50 p-8 rounded-xl shadow-lg backdrop-blur-sm max-w-2xl w-full">
        <h1 className="text-5xl font-bold text-white mb-2">Koligatif Quest</h1>
        <h2 className="text-2xl font-medium text-pink-200 mb-8">Petualangan Molekular</h2>
        
        <div className="w-full bg-pink-500/60 p-6 rounded-xl shadow-md backdrop-blur-sm border border-pink-400/30">
          <p className="text-lg mb-4 text-white">
            Selamat datang di petualangan sains molekuler! Jelajahi sifat koligatif larutan melalui eksperimen dan tantangan interaktif.
          </p>
          <p className="mb-6 text-pink-100">
            Kumpulkan poin, dapatkan energi molekul, dan capai prestasi sebagai ilmuwan kimia terbaik!
          </p>
          <button 
            onClick={goToLevels}
            className="bg-pink-400 hover:bg-pink-500 text-white py-3 px-8 rounded-lg font-bold flex items-center justify-center w-full"
          >
            Mulai Petualangan <Play className="ml-2" size={18} />
          </button>
        </div>
        
        <div className="grid grid-cols-2 gap-4 w-full mt-6">
          <div className="bg-pink-500/80 p-4 rounded-lg shadow-md border border-pink-400/30">
            <h3 className="font-semibold text-white">4 Level Utama</h3>
            <p className="text-sm text-pink-100">Pelajari konsep sifat koligatif dari dasar hingga kompleks</p>
          </div>
          <div className="bg-pink-500/80 p-4 rounded-lg shadow-md border border-pink-400/30">
            <h3 className="font-semibold text-white">Lab Virtual</h3>
            <p className="text-sm text-pink-100">Eksperimen dengan simulasi interaktif</p>
          </div>
          <div className="bg-pink-500/80 p-4 rounded-lg shadow-md border border-pink-400/30">
            <h3 className="font-semibold text-white">Tantangan Seru</h3>
            <p className="text-sm text-pink-100">Uji pemahaman dengan kuis dan puzzle kimia</p>
          </div>
          <div className="bg-pink-500/80 p-4 rounded-lg shadow-md border border-pink-400/30">
            <h3 className="font-semibold text-white">Reward System</h3>
            <p className="text-sm text-pink-100">Kumpulkan energi molekul dan buka pencapaian</p>
          </div>
        </div>
      </div>
    </div>
  );

  const LevelSelectScreen = () => (
    <div className="p-6 bg-pink-100 min-h-screen">
      <div className="max-w-4xl mx-auto">
        <div className="flex justify-between items-center mb-6 bg-pink-200 p-4 rounded-lg shadow-md">
          <h1 className="text-2xl font-bold text-pink-700">Pilih Level</h1>
          <div className="flex items-center space-x-4">
            <div className="flex items-center bg-white px-3 py-1 rounded-full">
              <Star className="text-yellow-500 mr-1" size={18} />
              <span className="font-semibold">{gameState.score}</span>
            </div>
            <div className="flex items-center bg-white px-3 py-1 rounded-full">
              <Beaker className="text-blue-500 mr-1" size={18} />
              <span className="font-semibold">{gameState.molecularEnergy}</span>
            </div>
          </div>
        </div>
        
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
          {levels.map(level => (
            <div 
              key={level.id}
              className={`bg-white rounded-lg shadow-md border overflow-hidden transition transform hover:scale-102
                        ${level.unlocked ? 'cursor-pointer hover:shadow-lg border-pink-300' : 'opacity-60 cursor-not-allowed border-gray-200'}`}
              onClick={() => level.unlocked && startLevel(level.id)}
            >
              <div className={`${level.color} py-3 px-4 flex justify-between items-center`}>
                <div className="flex items-center">
                  <div className="bg-white p-2 rounded-full mr-3">
                    {level.icon}
                  </div>
                  <h2 className="text-white font-bold">{level.title}</h2>
                </div>
                {level.completed && (
                  <Award className="text-yellow-300" size={24} />
                )}
              </div>
              <div className="p-4 bg-gradient-to-b from-pink-50 to-white">
                <div className="text-sm font-mono bg-pink-50 px-2 py-1 rounded mb-2 inline-block border border-pink-200">
                  {level.concept}
                </div>
                <p className="text-gray-600 mb-3">{level.description}</p>
                <div className="flex justify-end">
                  <button 
                    className={`flex items-center px-3 py-1 rounded-full ${level.unlocked ? 'bg-pink-500 text-white' : 'bg-gray-200 text-gray-400'}`}
                    disabled={!level.unlocked}
                  >
                    {level.unlocked ? "Mulai Level" : "Terkunci"} 
                    <ChevronRight size={16} className="ml-1" />
                  </button>
                </div>
              </div>
            </div>
          ))}
        </div>
      </div>
    </div>
  );

  const GameScreen = () => {
    const currentLevel = levels.find(l => l.id === gameState.currentLevel);
    
    return (
      <div className="p-6">
        <div className="flex justify-between items-center mb-6">
          <h1 className="text-2xl font-bold">
            <span className={`inline-block mr-2 ${currentLevel.color} text-white p-1 rounded`}>
              {currentLevel.icon}
            </span>
            {currentLevel.title}
          </h1>
          <div className="flex items-center space-x-4">
            <div className="flex items-center">
              <Star className="text-yellow-500 mr-1" size={18} />
              <span className="font-semibold">{gameState.score}</span>
            </div>
            <div className="flex items-center">
              <Beaker className="text-blue-500 mr-1" size={18} />
              <span className="font-semibold">{gameState.molecularEnergy}</span>
            </div>
          </div>
        </div>
        
        <div className="bg-white rounded-lg shadow-md p-6 mb-6">
          <h2 className="text-xl font-semibold mb-3">Konsep Dasar</h2>
          <div className="bg-gray-50 p-3 rounded-md font-mono text-center mb-4">
            {currentLevel.concept}
          </div>
          <p className="mb-4">
            {currentLevel.id === 1 && "Tekanan uap larutan dipengaruhi oleh fraksi mol zat terlarut. Semakin banyak zat terlarut yang ditambahkan, semakin rendah tekanan uap larutan tersebut."}
            {currentLevel.id === 2 && "Penambahan zat terlarut ke dalam pelarut akan menaikkan titik didih larutan. Kenaikan ini sebanding dengan konsentrasi molal zat terlarut."}
            {currentLevel.id === 3 && "Penambahan zat terlarut ke dalam pelarut akan menurunkan titik beku larutan. Penurunan ini bergantung pada jenis dan konsentrasi zat terlarut."}
            {currentLevel.id === 4 && "Tekanan osmotik terjadi ketika dua larutan dengan konsentrasi berbeda dipisahkan oleh membran semipermeable. Dipengaruhi oleh konsentrasi, suhu, dan faktor van't Hoff."}
          </p>
          
          <div className="flex flex-wrap gap-3">
            <button 
              onClick={startQuiz}
              className="bg-indigo-100 hover:bg-indigo-200 text-indigo-700 px-4 py-2 rounded-md flex items-center"
            >
              <Brain size={18} className="mr-2" />
              Mulai Kuis
            </button>
            <button 
              onClick={startLabSimulation}
              className="bg-green-100 hover:bg-green-200 text-green-700 px-4 py-2 rounded-md flex items-center"
            >
              <Beaker size={18} className="mr-2" />
              Simulasi Lab
            </button>
            <button 
              onClick={goToLevels}
              className="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-md flex items-center"
            >
              Kembali ke Level
            </button>
          </div>
        </div>
        
        <div className="bg-white rounded-lg shadow-md p-6">
          <h2 className="text-xl font-semibold mb-3">Peralatan & Power-ups</h2>
          <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
            {toolsAndPowerups.map(tool => (
              <div 
                key={tool.id}
                className={`border rounded-md p-3 text-center ${gameState.molecularEnergy >= tool.cost ? 'cursor-pointer hover:bg-gray-50' : 'opacity-50 cursor-not-allowed'}`}
                onClick={() => gameState.molecularEnergy >= tool.cost && useToolOrPowerup(tool.id)}
              >
                <div className="flex justify-center mb-2">
                  {tool.icon}
                </div>
                <h3 className="font-medium text-sm mb-1">{tool.name}</h3>
                <p className="text-xs text-gray-500 mb-2">{tool.description}</p>
                <div className="flex items-center justify-center text-xs font-semibold">
                  <Beaker size={14} className="mr-1 text-blue-500" />
                  {tool.cost}
                </div>
              </div>
            ))}
          </div>
        </div>
      </div>
    );
  };

  const QuizScreen = () => {
    const quiz = gameState.currentQuiz;
    
    if (!quiz) return <div>Loading quiz...</div>;
    
    return (
      <div className="p-6 max-w-2xl mx-auto">
        <div className="bg-white rounded-lg shadow-md p-6">
          <div className="flex justify-between items-center mb-6">
            <h2 className="text-xl font-bold">Kuis: {levels.find(l => l.id === gameState.currentLevel)?.title}</h2>
            <div className="bg-indigo-100 text-indigo-800 px-3 py-1 rounded-full font-medium">
              {gameState.timer}s
            </div>
          </div>
          
          <div className="mb-6">
            <p className="text-lg font-medium mb-4">{quiz.question}</p>
            
            <div className="space-y-3">
              {quiz.options.map((option, index) => (
                <button
                  key={index}
                  onClick={() => !gameState.quizAnswered && answerQuiz(index)}
                  disabled={gameState.quizAnswered}
                  className={`w-full text-left p-3 rounded-md border transition-colors
                    ${gameState.quizAnswered && index === quiz.correctAnswer ? 'bg-green-100 border-green-500' : ''}
                    ${gameState.quizAnswered && index === gameState.selectedAnswer && index !== quiz.correctAnswer ? 'bg-red-100 border-red-500' : ''}
                    ${!gameState.quizAnswered ? 'hover:bg-gray-50 cursor-pointer' : ''}
                  `}
                >
                  <div className="flex items-start">
                    <div className="flex-shrink-0 w-6 h-6 flex items-center justify-center rounded-full border mr-2 text-sm">
                      {String.fromCharCode(65 + index)}
                    </div>
                    <span>{option}</span>
                  </div>
                </button>
              ))}
            </div>
          </div>
          
          {gameState.quizAnswered && (
            <div className={`p-4 rounded-md mb-4 ${gameState.selectedAnswer === quiz.correctAnswer ? 'bg-green-50 border border-green-200' : 'bg-red-50 border border-red-200'}`}>
              <h3 className={`font-bold mb-1 ${gameState.selectedAnswer === quiz.correctAnswer ? 'text-green-700' : 'text-red-700'}`}>
                {gameState.selectedAnswer === quiz.correctAnswer ? 'Benar!' : 'Kurang tepat'}
              </h3>
              <p>{quiz.explanation}</p>
            </div>
          )}
          
          <div className="flex justify-end space-x-3">
            {gameState.quizAnswered && (
              <button
                onClick={() => setGameState({...gameState, screen: 'game'})}
                className="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-md"
              >
                Kembali ke Level
              </button>
            )}
          </div>
        </div>
      </div>
    );
  };

  const LabScreen = () => {
    const labData = gameState.labData;
    const results = labData.results;
    const simulation = labSimulations[gameState.currentLevel];
    
    return (
      <div className="p-6 max-w-2xl mx-auto">
        <div className="bg-white rounded-lg shadow-md p-6">
          <h2 className="text-xl font-bold mb-4">{simulation.title}</h2>
          <p className="mb-6">{simulation.description}</p>
          
          <div className="bg-blue-50 p-4 rounded-md mb-6">
            <h3 className="font-semibold mb-3">Parameter Eksperimen</h3>
            
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium mb-1">
                  Massa pelarut (air)
                </label>
                <div className="flex items-center">
                  <input
                    type="number"
                    value={labData.solventMass}
                    disabled
                    className="border rounded-md p-2 w-full bg-gray-100"
                  />
                  <span className="ml-2 text-gray-500">g</span>
                </div>
                <p className="text-xs text-gray-500 mt-1">
                  Tetap: 100g air pada 25°C
                </p>
              </div>
              
              <div>
                <label className="block text-sm font-medium mb-1">
                  Massa zat terlarut
                </label>
                <div className="flex items-center">
                  <input
                    type="number"
                    min="0"
                    max="100"
                    value={labData.soluteMass}
                    onChange={(e) => updateLabParameter('soluteMass', Number(e.target.value))}
                    className="border rounded-md p-2 w-full"
                  />
                  <span className="ml-2 text-gray-500">g</span>
                </div>
                <p className="text-xs text-gray-500 mt-1">
                  Gunakan zat terlarut non-elektrolit (mis. gula, massa molar 60 g/mol)
                </p>
              </div>
            </div>
            
            <div className="mt-4">
              <button
                onClick={calculateLabResults}
                className="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md"
              >
                Jalankan Eksperimen
              </button>
            </div>
          </div>
          
          {results && (
            <div className="bg-indigo-50 p-4 rounded-md mb-6">
              <h3 className="font-semibold mb-3">Hasil Eksperimen</h3>
              
              <div className="grid grid-cols-2 gap-4">
                <div className="bg-white p-3 rounded-md shadow-sm">
                  <div className="text-sm text-gray-500">Fraksi Mol Zat Terlarut</div>
                  <div className="text-xl font-semibold">{results.soluteMoleFraction}</div>
                </div>
                
                <div className="bg-white p-3 rounded-md shadow-sm">
                  <div className="text-sm text-gray-500">Fraksi Mol Pelarut</div>
                  <div className="text-xl font-semibold">{results.solventMoleFraction}</div>
                </div>
                
                <div className="bg-white p-3 rounded-md shadow-sm">
                  <div className="text-sm text-gray-500">Tekanan Uap Larutan</div>
                  <div className="text-xl font-semibold">{results.vaporPressure} mmHg</div>
                </div>
                
                <div className="bg-white p-3 rounded-md shadow-sm">
                  <div className="text-sm text-gray-500">Penurunan Tekanan Uap</div>
                  <div className="text-xl font-semibold">{results.pressureReduction} mmHg</div>
                </div>
              </div>
              
              <div className="mt-4 p-3 bg-yellow-50 rounded-md border border-yellow-200">
                <h4 className="font-medium text-yellow-800 mb-1">Analisis</h4>
                <p className="text-sm">
                  Sesuai Hukum Raoult, penurunan tekanan uap sebanding dengan fraksi mol zat terlarut.
                  Dengan fraksi mol zat terlarut {results.soluteMoleFraction}, tekanan uap menurun sebesar {results.pressureReduction} mmHg.
                </p>
              </div>
            </div>
          )}
          
          <div className="flex justify-end">
            <button
              onClick={() => setGameState({...gameState, screen: 'game'})}
              className="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-md"
            >
              Kembali ke Level
            </button>
          </div>
        </div>
      </div>
    );
  };

  // Main content renderer
  const renderContent = () => {
    switch (gameState.screen) {
      case 'welcome':
        return <WelcomeScreen />;
      case 'levels':
        return <LevelSelectScreen />;
      case 'game':
        return <GameScreen />;
      case 'quiz':
        return <QuizScreen />;
      case 'lab':
        return <LabScreen />;
      default:
        return <WelcomeScreen />;
    }
  };

  return (
    <div className="bg-gray-100 min-h-screen">
      {renderContent()}
    </div>
  );
}